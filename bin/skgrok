#!/usr/bin/env bash

set -euo pipefail

function _script_dir() {
  dirname "${BASH_SOURCE[0]}"
}

function _check_command() {
  command -v "$1" &>/dev/null
}

function _fuzzy_view() {
  local -r pager="${PAGER:-less}"

  local -r contents=$(cat -)

  if _check_command fzf; then
    echo "$contents" | fzf
  else
    echo "$contents" | $pager
  fi
}

function default() {
  # TODO: re-use sk_pad_right in this
  # TODO: extract left out to a sk_left function or something
  local -r script=$(
    cat <<-'EOF'
fn pad_right(s, pad_char, target_length): (
  len(s) < target_length ? pad_right(f'{s}{pad_char}', pad_char, target_length) : s
)

-- left truncates the string to n characters with ellipsis if the string is
-- longer than n. this is also done due to a bug in early versions of super
-- when slicing strings shorter than the target length.
-- https://github.com/brimdata/super/issues/5688
fn left(s, n): (
  len(s) < n ? s : f'{s[:n]}...'
)

collect(this)
| {data: this, max_len:[unnest this | max(len(pattern_name))]}
| unnest {this.max_len, this.data} into (
    values f'{pad_right(this.data.pattern_name, ' ', (this.max_len + 1))}{left(this.data.regex, 60+this.max_len)}'
  )
EOF
  )

  if _check_command super; then
    super -f text -c "$script" "$(_script_dir)/skgrok.jsup" | _fuzzy_view
  else
    echo "ERROR: Could not find 'super' on PATH"
    exit 1
  fi
}

default
