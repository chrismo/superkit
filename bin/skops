#!/usr/bin/env bash

set -euo pipefail

function _script_dir() {
  dirname "${BASH_SOURCE[0]}"
}

function _check_command() {
  command -v "$1" &>/dev/null
}

function _fuzzy_view() {
  local -r pager="${PAGER:-less}"

  local -r contents=$(cat -)

  if _check_command fzf; then
    echo "$contents" |
      tr '¶' '\n' | tr '§' '\0' |
      fzf --read0 --gap --highlight-line --layout reverse
  else
    echo "$contents" | $pager
  fi
}

function default() {
  if _check_command super; then
    super -f line -I "$(_script_dir)/skops.spq" \
      -c "skops_multi_line()" "$(_script_dir)/skops.jsup" | _fuzzy_view
  elif _check_command zq; then
    zq -f text -I "$(_script_dir)/skops.spq" \
      "skops_multi_line()" "$(_script_dir)/skops.jsup" | _fuzzy_view
  else
    echo "ERROR: Could not find 'super' or 'zq' commands"
    exit 1
  fi
}

default "$@"
